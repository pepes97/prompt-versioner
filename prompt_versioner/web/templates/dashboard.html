<!DOCTYPE html>
<html>
<head>
    <title>Prompt Versioner Dashboard</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">

    <!-- CSS Modules -->
    <link rel="stylesheet" href="{{ url_for('static', filename='css/base.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/theme.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/layout.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/components.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/prompts.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/versions.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/metrics.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/annotations.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/ab-testing.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/alerts.css') }}">
</head>
<body>
    <!-- Improved Header -->
    <header class="dashboard-header">
        <div class="header-content">
            <div class="header-left">
                <h1 class="header-title">
                    <span class="header-icon">üöÄ</span>
                    Prompt Versioner
                </h1>
                <span class="header-subtitle">AI Prompt Management Dashboard</span>
            </div>
            <div class="header-right">
                <button class="theme-toggle" onclick="toggleTheme()" aria-label="Toggle theme">
                    <span id="theme-icon">üåô</span>
                </button>
            </div>
        </div>
    </header>

    <div class="container">

        <!-- Enhanced Stats Cards -->
        <div class="stats" id="stats">
            <div class="stat-card stat-card-prompts">
                <div class="stat-icon">üìù</div>
                <div class="stat-content">
                    <div class="stat-label">Total Prompts</div>
                    <div class="stat-value" id="total-prompts">-</div>
                </div>
            </div>
            <div class="stat-card stat-card-versions">
                <div class="stat-icon">üîÑ</div>
                <div class="stat-content">
                    <div class="stat-label">Total Versions</div>
                    <div class="stat-value" id="total-versions">-</div>
                </div>
            </div>
            <div class="stat-card stat-card-cost">
                <div class="stat-icon">üí∞</div>
                <div class="stat-content">
                    <div class="stat-label">Total Cost</div>
                    <div class="stat-value" id="total-cost">-</div>
                    <div class="stat-sublabel">EUR</div>
                </div>
            </div>
            <div class="stat-card stat-card-tokens">
                <div class="stat-icon">üî§</div>
                <div class="stat-content">
                    <div class="stat-label">Total Tokens</div>
                    <div class="stat-value" id="total-tokens">-</div>
                </div>
            </div>
            <div class="stat-card stat-card-calls">
                <div class="stat-icon">üìû</div>
                <div class="stat-content">
                    <div class="stat-label">Total Calls</div>
                    <div class="stat-value" id="total-calls">-</div>
                </div>
            </div>
        </div>

        <!-- Streamlined Prompts Section -->
        <section class="prompts-section">
            <div class="section-header">
                <h2 class="section-title">
                    <span class="section-icon">üìù</span>
                    Prompts
                </h2>
                <div class="section-actions">
                    <button class="btn btn-icon" onclick="exportAll()" title="Export All">
                        üì¶
                    </button>
                    <button class="btn btn-icon" onclick="document.getElementById('import-file').click()" title="Import">
                        üì•
                    </button>
                    <input type="file" id="import-file" accept=".json" style="display: none;" onchange="importPrompt()" />
                </div>
            </div>

            <!-- Minimal Search Bar -->
            <div class="search-bar">
                <input
                    type="text"
                    id="search-input"
                    placeholder="Search prompts..."
                    oninput="filterPrompts()"
                    class="search-input-minimal"
                />
                <select id="sort-select" onchange="sortPrompts()" class="sort-select-minimal">
                    <option value="name-asc">A-Z</option>
                    <option value="name-desc">Z-A</option>
                    <option value="date-desc">Recent</option>
                    <option value="versions-desc">Most versions</option>
                </select>
            </div>

            <!-- Two Column Layout -->
            <div class="prompts-layout">
                <!-- Left: Prompt List -->
                <div class="prompts-sidebar">
                    <div class="prompt-list-minimal" id="prompt-list">
                        <div class="loading">Loading...</div>
                    </div>
                </div>

                <!-- Right: Version Details -->
                <div class="versions-panel" id="version-section">
                    <div class="versions-placeholder">
                        <div class="placeholder-icon">üìÇ</div>
                        <h3>Select a prompt</h3>
                        <p>Choose a prompt from the left to view its versions</p>
                    </div>
                </div>
            </div>

            <!-- Advanced Features Toggles -->
            <div class="advanced-controls" style="margin-top: 2rem; display: flex; gap: 1rem; flex-wrap: wrap;">
                <button class="btn btn-secondary" onclick="toggleABTesting()" id="ab-toggle-btn">
                    üß™ Enable A/B Testing
                </button>
                <button class="btn btn-secondary" onclick="DiffComparison.toggleVersionComparison()" id="diff-toggle-btn">
                    üîÑ Compare Versions
                </button>
                <button class="btn btn-secondary" onclick="toggleAlerts()" id="alerts-toggle-btn">
                    ‚ö†Ô∏è Show Alerts
                </button>
            </div>
        </section>

        <!-- Version Comparison Section -->
        <div id="diff-section" style="display: none; margin-top: 2rem;">
            <h2 style="color: #3b82f6; display: flex; align-items: center; gap: 0.5rem;">
                üîÑ Version Comparison
                <button onclick="DiffComparison.toggleVersionComparison()" style="background: #ef4444; color: white; border: none; border-radius: 4px; padding: 0.25rem 0.75rem; font-size: 0.875rem; cursor: pointer;">
                    ‚úï Close
                </button>
            </h2>

            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap; align-items: center;">
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; color: #94a3b8; font-size: 0.875rem;">Prompt:</label>
                    <select id="diff-prompt-select" onchange="loadVersionsForDiff()" style="padding: 0.5rem; border: 1px solid #334155; border-radius: 4px; background: #1e293b; color: #f1f5f9;">
                        <option value="">Select prompt...</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; color: #94a3b8; font-size: 0.875rem;">üìä BASELINE version (old)</label>
                    <select id="diff-version-a-select" style="padding: 0.5rem; border: 1px solid #334155; border-radius: 4px; background: #1e293b; color: #f1f5f9;">
                        <option value="">Select BASELINE version (old)</option>
                    </select>
                </div>
                <div>
                    <label style="display: block; margin-bottom: 0.25rem; color: #94a3b8; font-size: 0.875rem;">üÜö COMPARISON version (new)</label>
                    <select id="diff-version-b-select" style="padding: 0.5rem; border: 1px solid #334155; border-radius: 4px; background: #1e293b; color: #f1f5f9;">
                        <option value="">Select COMPARISON version (new)</option>
                    </select>
                </div>
                <div style="margin-top: 1.5rem;">
                    <button onclick="DiffComparison.compareDiffVersions()" style="padding: 0.5rem 1.5rem; background: #3b82f6; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                        Compare
                    </button>
                </div>
            </div>

            <div id="diff-results"></div>
        </div>

        <!-- A/B Test Section -->
        <div id="ab-test-section" style="display: none; margin-top: 2rem;">
            <h2>üß™ A/B Test Comparison</h2>

            <div style="display: flex; gap: 1rem; margin-bottom: 1rem; flex-wrap: wrap;">
                <!-- Prompt Selection -->
                <select id="ab-prompt-select" onchange="ABTesting.loadVersionsForAB()" style="padding: 0.5rem; border: 1px solid #334155; border-radius: 4px; background: #1e293b; color: #f1f5f9;">
                    <option value="">Select prompt...</option>
                </select>

                <!-- Version A Selection -->
                <select id="ab-version-a-select" style="padding: 0.5rem; border: 1px solid #334155; border-radius: 4px; background: #1e293b; color: #f1f5f9;">
                    <option value="">üìä Select Version A (baseline)...</option>
                </select>

                <span style="align-self: center; color: #94a3b8;">vs</span>

                <!-- Version B Selection -->
                <select id="ab-version-b-select" style="padding: 0.5rem; border: 1px solid #334155; border-radius: 4px; background: #1e293b; color: #f1f5f9;">
                    <option value="">üÜö Select Version B (comparison)...</option>
                </select>

                <!-- Metric Selection -->
                <select id="ab-metric-select" style="padding: 0.5rem; border: 1px solid #334155; border-radius: 4px; background: #1e293b; color: #f1f5f9;">
                    <option value="quality_score">Quality Score</option>
                    <option value="cost">Cost (USD)</option>
                    <option value="latency">Latency (ms)</option>
                    <option value="accuracy">Accuracy</option>
                </select>

                <button onclick="ABTesting.runABTest()" style="padding: 0.5rem 1.5rem; background: #0ea5e9; color: white; border: none; border-radius: 4px; cursor: pointer; font-weight: 600;">
                    Compare
                </button>
            </div>

            <div id="ab-test-results"></div>
        </div>

        <!-- Version Section -->
        <div id="version-section" style="display: none;">
            <h2 id="version-title">Versions</h2>
            <div class="version-list" id="version-list"></div>
        </div>

        <!-- Alerts Section -->
        <div class="alerts-section" id="alerts-section" style="display: none;">
            <h2>‚ö†Ô∏è Performance Alerts</h2>
            <div id="alerts-container"></div>
        </div>
    </div>

    <!-- HTML Templates -->
    <template id="prompt-item-template">
        <div class="prompt-item-minimal">
            <div class="prompt-info">
                <div class="prompt-name-minimal"></div>
                <div class="prompt-meta-minimal"></div>
            </div>
            <div class="prompt-actions-minimal">
                <button class="btn-icon btn-icon-small delete-prompt-btn" title="Elimina prompt">
                    üóëÔ∏è
                </button>
            </div>
        </div>
    </template>

    <template id="version-item-template">
        <div class="version-item-clean">
            <div class="version-item-header">
                <span class="version-tag-clean"></span>
                <div class="version-actions">
                    <button class="btn-icon btn-icon-small view-details-btn" title="Visualizza dettagli">
                        üëÅÔ∏è
                    </button>
                    <button class="btn-icon btn-icon-small delete-version-btn" title="Elimina versione">
                        üóëÔ∏è
                    </button>
                </div>
            </div>
            <div class="version-meta"></div>
            <div class="version-metrics-container"></div>
        </div>
    </template>

    <template id="version-modal-template">
        <div id="versionModal" class="modal-overlay">
            <div class="modal-content">
                <button class="modal-close-btn">‚úï Close</button>

                <div class="modal-header">
                    <h2 class="modal-title">
                        <span class="modal-icon">üìÑ</span>
                        <span class="modal-prompt-name"></span>
                        <span class="modal-version-number"></span>
                        <span class="modal-model-badge"></span>
                    </h2>
                </div>

                <div class="modal-body">
                    <div class="system-prompt-section">
                        <h3 class="section-title">üß† System Prompt</h3>
                        <div class="prompt-content system-prompt-content"></div>
                    </div>

                    <div class="user-prompt-section">
                        <h3 class="section-title">üí¨ User Prompt</h3>
                        <div class="prompt-content user-prompt-content"></div>
                    </div>

                    <div class="metrics-section">
                        <!-- Metrics will be populated here -->
                    </div>

                    <div class="metadata-grid">
                        <div class="metadata-item">
                            <h4>üìÖ Creation Date</h4>
                            <p class="creation-date"></p>
                        </div>
                        <div class="metadata-item">
                            <h4>üè∑Ô∏è Tags</h4>
                            <p class="tags-list"></p>
                        </div>
                        <div class="metadata-item">
                            <h4>ü§ñ Model</h4>
                            <p class="model-name"></p>
                        </div>
                    </div>

                    <div class="git-commit-section" style="display: none;">
                        <h4>üîó Git Commit</h4>
                        <p class="git-commit"></p>
                    </div>

                    <div class="created-by-section" style="display: none;">
                        <h4>üë®‚Äçüíª Creato da</h4>
                        <p class="created-by"></p>
                    </div>

                    <div class="metadata-json-section" style="display: none;">
                        <h4>‚öôÔ∏è Metadata</h4>
                        <pre class="metadata-json"></pre>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <template id="empty-state-template">
        <div class="empty-state">
            <div class="empty-icon"></div>
            <h3 class="empty-title"></h3>
            <p class="empty-message"></p>
        </div>
    </template>

    <template id="loading-state-template">
        <div class="loading-state">
            <div class="loading-icon">‚è≥</div>
            <p>Loading...</p>
        </div>
    </template>

    <template id="error-state-template">
        <div class="error-state">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h3 class="error-title">Errore</h3>
            <p class="error-message"></p>
            <button class="retry-btn">üîÑ Riprova</button>
        </div>
    </template>

    <template id="metrics-row-template">
        <div class="version-metrics">
            <div class="metrics-row">
                <span class="metric-item metric-calls">üìû <span class="value"></span> calls</span>
                <span class="metric-item metric-tokens">üî§ <span class="value"></span> avg tokens</span>
                <span class="metric-item metric-cost">üí∞ ‚Ç¨<span class="value"></span></span>
                <span class="metric-item metric-latency">‚ö° <span class="value"></span>ms</span>
                <span class="metric-item metric-quality">‚≠ê <span class="value"></span> quality</span>
                <span class="metric-item metric-success">‚úÖ <span class="value"></span>% success</span>
            </div>
        </div>
    </template>

    <template id="no-metrics-template">
        <div class="no-metrics">üìä No metrics available</div>
    </template>

    <template id="modal-metrics-section-template">
        <div>
            <h3 class="section-title metrics-title">üìä Performance Metrics</h3>
            <div class="modal-metrics-section">
                <div class="metrics-container">
                    <div class="metrics-grid">
                        <div class="metric-card metric-calls">
                            <div class="metric-icon">üìû</div>
                            <div class="metric-value"></div>
                            <div class="metric-label">Total Calls</div>
                        </div>
                        <div class="metric-card metric-tokens">
                            <div class="metric-icon">üî§</div>
                            <div class="metric-value"></div>
                            <div class="metric-label">Avg Tokens</div>
                        </div>
                        <div class="metric-card metric-cost">
                        <div class="metric-icon">üí∞</div>
                        <div class="metric-value"></div>
                        <div class="metric-label">Total Cost</div>
                    </div>
                    <div class="metric-card metric-latency">
                        <div class="metric-icon">‚ö°</div>
                        <div class="metric-value"></div>
                        <div class="metric-label">Avg Latency</div>
                    </div>
                    <div class="metric-card metric-quality">
                        <div class="metric-icon">‚≠ê</div>
                        <div class="metric-value"></div>
                        <div class="metric-label">Avg Quality</div>
                    </div>
                    <div class="metric-card metric-success">
                        <div class="metric-icon">‚úÖ</div>
                        <div class="metric-value"></div>
                        <div class="metric-label">Success Rate</div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- Diff Comparison Templates -->
    <template id="diff-comparison-template">
        <div class="diff-comparison-container">
            <div class="diff-versions-grid">
                <div class="diff-version-card baseline">
                    <h3 class="diff-version-title">
                        üìä BASELINE Version <span class="version-number"></span>
                        <span class="version-date"></span>
                        <span class="version-model-badge"></span>
                    </h3>
                    <div class="diff-version-content">
                        <h4>System Prompt:</h4>
                        <pre class="system-prompt-content"></pre>
                        <h4>User Prompt:</h4>
                        <pre class="user-prompt-content"></pre>
                    </div>
                </div>

                <div class="diff-version-card comparison">
                    <h3 class="diff-version-title">
                        üÜö COMPARISON Version <span class="version-number"></span>
                        <span class="version-date"></span>
                        <span class="version-model-badge"></span>
                    </h3>
                    <div class="diff-version-content">
                        <h4>System Prompt:</h4>
                        <pre class="system-prompt-content"></pre>
                        <h4>User Prompt:</h4>
                        <pre class="user-prompt-content"></pre>
                    </div>
                </div>
            </div>

            <div class="diff-changes-section"></div>
        </div>
    </template>

    <template id="diff-no-changes-template">
        <div class="diff-no-changes">
            <h3>‚úÖ No Changes Detected</h3>
            <p>The prompts are identical between these versions.</p>
        </div>
    </template>

    <template id="diff-changes-template">
        <div class="diff-changes-container">
            <h3>üìä Changes from BASELINE to COMPARISON</h3>

            <div class="system-changes-section" style="display: none;">
                <h4>ü§ñ System Prompt Changes:</h4>
                <div class="diff-content system-changes"></div>
            </div>

            <div class="user-changes-section" style="display: none;">
                <h4>üë§ User Prompt Changes:</h4>
                <div class="diff-content user-changes"></div>
            </div>

            <div class="similarity-section" style="display: none;">
                <h4>üìà Similarity Analysis:</h4>
                <div class="similarity-stats">
                    <div class="similarity-stat">
                        <div class="stat-label">System Similarity</div>
                        <div class="stat-value system-similarity"></div>
                    </div>
                    <div class="similarity-stat">
                        <div class="stat-label">User Similarity</div>
                        <div class="stat-value user-similarity"></div>
                    </div>
                    <div class="similarity-stat">
                        <div class="stat-label">Overall Similarity</div>
                        <div class="stat-value total-similarity"></div>
                    </div>
                </div>
            </div>

            <div class="metrics-comparison-section">
                <h4>üìä Metrics Comparison:</h4>
                <div class="metrics-comparison-grid">
                    <div class="metric-comparison-item">
                        <div class="metric-comparison-label">üí∞ Cost</div>
                        <div class="metric-comparison-values">
                            <span class="baseline-value cost-baseline">--</span>
                            <span class="comparison-arrow">‚Üí</span>
                            <span class="comparison-value cost-comparison">--</span>
                            <span class="metric-change cost-change"></span>
                        </div>
                    </div>

                    <div class="metric-comparison-item">
                        <div class="metric-comparison-label">üì• Avg Input Tokens</div>
                        <div class="metric-comparison-values">
                            <span class="baseline-value input-tokens-baseline">--</span>
                            <span class="comparison-arrow">‚Üí</span>
                            <span class="comparison-value input-tokens-comparison">--</span>
                            <span class="metric-change input-tokens-change"></span>
                        </div>
                    </div>

                    <div class="metric-comparison-item">
                        <div class="metric-comparison-label">üì§ Avg Output Tokens</div>
                        <div class="metric-comparison-values">
                            <span class="baseline-value output-tokens-baseline">--</span>
                            <span class="comparison-arrow">‚Üí</span>
                            <span class="comparison-value output-tokens-comparison">--</span>
                            <span class="metric-change output-tokens-change"></span>
                        </div>
                    </div>

                    <div class="metric-comparison-item">
                        <div class="metric-comparison-label">‚ö° Latency</div>
                        <div class="metric-comparison-values">
                            <span class="baseline-value latency-baseline">--</span>
                            <span class="comparison-arrow">‚Üí</span>
                            <span class="comparison-value latency-comparison">--</span>
                            <span class="metric-change latency-change"></span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </template>

    <!-- A/B Testing Templates -->
    <template id="ab-results-template">
        <div class="ab-results-container">
            <h3 class="ab-results-title">A/B Test Results</h3>

            <div class="ab-results-grid">
                <div class="ab-version-result-card">
                    <h4 class="ab-version-subtitle">üìä Version A (Baseline)</h4>
                    <div class="ab-version-number"></div>
                    <div class="ab-metric-value"></div>
                    <div class="ab-model-info"></div>
                </div>

                <div class="ab-version-result-card">
                    <h4 class="ab-version-subtitle">üÜö Version B (Comparison)</h4>
                    <div class="ab-version-number"></div>
                    <div class="ab-metric-value"></div>
                    <div class="ab-model-info"></div>
                </div>
            </div>

            <div class="ab-summary">
                <div class="ab-winner-text"></div>
                <div class="ab-improvement-text"></div>
            </div>
        </div>
    </template>

    <template id="ab-error-template">
        <div class="ab-error">
            <span class="error-message"></span>
        </div>
    </template>

    <!-- Alert Templates -->
    <template id="alert-item-template">
        <div class="alert-item">
            <div class="alert-header">
                <h4 class="alert-title"></h4>
                <span class="alert-severity-badge"></span>
            </div>
            <p class="alert-message"></p>
            <small class="alert-timestamp"></small>
        </div>
    </template>

    <template id="alerts-empty-template">
        <div class="alerts-empty">No alerts at this time</div>
    </template>

    <template id="alerts-error-template">
        <div class="alerts-error">Error loading alerts</div>
    </template>

    <!-- Word-level Diff Template -->
    <template id="word-level-diff-template">
        <div class="word-level-diff">
            <div class="diff-content"></div>
            <div class="diff-summary">
                <strong>Summary:</strong>
                <span class="added-words"></span>
                <span class="removed-words"></span>
            </div>
        </div>
    </template>

    <!-- No Changes Template -->
    <template id="no-changes-template">
        <div class="no-changes-message">
            <div class="no-changes-icon">‚úÖ</div>
            <div class="no-changes-title">No Changes Detected</div>
            <div class="no-changes-text">The prompts are identical between these versions.</div>
        </div>
    </template>

    <!-- Error Message Template -->
    <template id="error-message-template">
        <div class="error-message">
            <div class="error-icon">‚ö†Ô∏è</div>
            <div class="error-title"></div>
            <div class="error-text"></div>
        </div>
    </template>

    <!-- Loading Message Template -->
    <template id="loading-message-template">
        <div class="loading-message">
            <div class="loading-icon">üîÑ</div>
            <div class="loading-text"></div>
        </div>
    </template>

    <!-- No Content Template -->
    <template id="no-content-template">
        <div class="no-content-message">
            <div class="no-content-icon">üìù</div>
            <div class="no-content-text"></div>
        </div>
    </template>

    <!-- JavaScript Modules -->
    <script src="{{ url_for('static', filename='js/utils.js') }}"></script>
    <script src="{{ url_for('static', filename='js/api.js') }}"></script>
    <script src="{{ url_for('static', filename='js/theme.js') }}"></script>
    <script src="{{ url_for('static', filename='js/prompts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/versions.js') }}"></script>
    <script src="{{ url_for('static', filename='js/ab-testing.js') }}"></script>
    <script src="{{ url_for('static', filename='js/alerts.js') }}"></script>
    <script src="{{ url_for('static', filename='js/export-import.js') }}"></script>
    <script src="{{ url_for('static', filename='js/diff-comparison.js') }}"></script>
    <script src="{{ url_for('static', filename='js/main.js') }}"></script>
</body>
</html>
